---
import { getCollection } from 'astro:content';
import Layout from '../layouts/Layout.astro';
import { SERIES_MAP } from '../utils/seriesMap';

// 1. LẤY DỮ LIỆU
const allSongs = await getCollection('songs');

// 2. LOGIC THÔNG BÁO (ĐÃ FIX: So sánh chính xác từng mili-giây)
const newUpdates = allSongs
  .filter(song => song.data.date)
  .sort((a, b) => {
      // Chuyển về timestamp (số) để so sánh chính xác tuyệt đối
      const timeA = new Date(a.data.date!).getTime();
      const timeB = new Date(b.data.date!).getTime();
      return timeB - timeA; // Mới nhất lên đầu
  })
  .slice(0, 3);

// 3. LOGIC LIST SERIES
const uniqueSeriesIds = [...new Set(allSongs.map(song => song.slug.split('/')[0]))];

const seriesList = uniqueSeriesIds.map(id => {
  const info = SERIES_MAP[id] || { romaji: id, vietnamese: id, year: "" };
  
  let finalCover = info.cover || ""; 
  if (!finalCover) {
      const representativeSong = allSongs.find(song => song.slug.startsWith(`${id}/`) && (song.data.cover || song.data.logo)) 
                              || allSongs.find(song => song.slug.startsWith(`${id}/`));
      
      const rawCover = representativeSong?.data.cover || representativeSong?.data.logo;
      if (rawCover) {
        if (typeof rawCover === 'object' && 'src' in rawCover) {
            finalCover = rawCover.src;
        } else {
            finalCover = String(rawCover);
        }
      }
  }
  if (finalCover.startsWith('/covers/')) {
      finalCover = import.meta.env.BASE_URL + finalCover.substring(1);
  }

  return { id, info, cover: finalCover };
}).sort((a, b) => a.info.vietnamese.localeCompare(b.info.vietnamese));

const initialCover = seriesList[0]?.cover || "";
---

<Layout title="Trang chủ | Rainei Lyrics List" isHome={true}>
  
  <div class="h-full flex flex-col px-6 pb-2 pt-6 max-w-[1800px] mx-auto w-full">
    
    <div class="text-center shrink-0 mb-6">
       <h1 class="text-3xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-sky-400 to-purple-500">
        Rainei Lyrics List
      </h1>
      <p class="text-slate-500 text-sm mt-1">Tổng hợp lời Việt hoá các bài hát do mình thực hiện.</p>
    </div>

    <div class="flex-1 grid grid-cols-12 gap-8 min-h-0 mb-4">
      
      <div class="hidden lg:block col-span-4 h-full relative group rounded-2xl overflow-hidden border border-slate-800 shadow-2xl bg-slate-900/50">
          <img 
            id="preview-img" 
            src={initialCover} 
            class={`w-full h-full object-contain transition-all duration-700 ${initialCover ? '' : 'opacity-0'}`}
            alt="Preview"
          />
          <div 
            id="preview-placeholder" 
            class={`absolute inset-0 flex items-center justify-center bg-slate-800 text-slate-600 transition-opacity duration-500 ${initialCover ? 'opacity-0' : ''}`}
          >
             <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="0.5" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></svg>
          </div>
      </div>

      <div class="col-span-12 lg:col-span-8 flex flex-col h-full gap-6">
        
        <div class="bg-slate-900/40 border border-sky-500/20 rounded-xl p-4 backdrop-blur-sm shrink-0">
            <div class="flex items-center gap-2 mb-3 text-sky-400 font-bold uppercase tracking-widest text-xs">
              <span class="relative flex h-2 w-2">
                <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-sky-400 opacity-75"></span>
                <span class="relative inline-flex rounded-full h-2 w-2 bg-sky-500"></span>
              </span>
              Vừa cập nhật
            </div>
            
            <div class="grid gap-2">
              {newUpdates.length > 0 ? newUpdates.map((song) => {
                const seriesId = song.slug.split('/')[0];
                const songId = song.slug.split('/').pop();
                const seriesName = SERIES_MAP[seriesId]?.vietnamese || seriesId;

                return (
                  <a href={`/series/${seriesId}#${songId}`} class="flex items-center justify-between p-2 rounded hover:bg-white/5 group transition-colors">
                    <div class="flex items-center gap-2 overflow-hidden">
                       <span class="text-xs font-bold text-sky-500/70 bg-sky-500/10 px-1.5 py-0.5 rounded border border-sky-500/20 whitespace-nowrap">
                         {seriesName}
                       </span>
                       <span class="text-sm text-slate-300 group-hover:text-white truncate font-medium">
                         {song.data.title}
                       </span>
                       <span class="text-[10px] text-slate-500 border border-slate-700 px-1 rounded ml-1 whitespace-nowrap">
                         {song.data.season || ""}
                       </span>
                    </div>
                    
                    <span class="text-xs text-slate-600 font-mono ml-4 whitespace-nowrap">
                      {song.data.date ? song.data.date.toLocaleDateString('vi-VN') : ''}
                    </span>
                  </a>
                );
              }) : <div class="text-slate-500 text-sm italic">Chưa có dữ liệu mới.</div>}
            </div>
        </div>

        <div class="flex-1 flex flex-col min-h-0 bg-slate-900/20 border border-slate-800/50 rounded-xl overflow-hidden">
            <div class="px-5 py-3 text-xs font-bold text-slate-500 uppercase tracking-widest border-b border-slate-800 bg-slate-900/50">
              Danh sách phim
            </div>
            
            <div class="flex-1 overflow-y-auto custom-scrollbar p-2">
              {seriesList.map((series) => (
                <a 
                  href={`/series/${series.id}`}
                  class="song-row group flex items-center px-4 py-3 hover:bg-slate-800/60 transition-all duration-200 cursor-pointer 
                         border-b border-slate-800/50 last:border-b-0 rounded-lg hover:rounded-lg" 
                  data-cover={series.cover} 
                >
                  {/* ^ ĐÃ SỬA CLASS Ở TRÊN:
                      - border-b border-slate-800/50: Tạo gạch mờ ở dưới
                      - last:border-b-0: Cái cuối cùng không gạch
                      - rounded-lg hover:rounded-lg: Giữ bo góc khi hover cho đẹp
                  */}
                  <div class="flex flex-col group-hover:translate-x-1 transition-transform">
                      <div class="font-bold text-slate-300 group-hover:text-white text-lg leading-tight">
                          {series.info.vietnamese}
                          {series.info.year && <span class="text-slate-600 text-sm font-normal ml-2">({series.info.year})</span>}
                      </div>
                      <div class="text-xs text-slate-500 font-mono mt-1 group-hover:text-sky-500/70 transition-colors">
                          {series.info.romaji}
                      </div>
                  </div>
                </a>
              ))}
            </div>
        </div>

      </div>
    </div>

    <div class="shrink-0 text-center border-t border-slate-900 pt-4 text-slate-600 text-xs">
        &copy; 2026 Rainei Lyrics List.
    </div>

  </div>

  <script>
    const previewImg = document.getElementById('preview-img');
    const placeholder = document.getElementById('preview-placeholder');
    const rows = document.querySelectorAll('.song-row');

    rows.forEach(row => {
      row.addEventListener('mouseenter', () => {
        const cover = row.getAttribute('data-cover');
        if (cover && cover !== "") {
            previewImg.src = cover;
            previewImg.classList.remove('opacity-0'); 
            placeholder.classList.add('opacity-0');   
        } else {
            previewImg.classList.add('opacity-0');    
            placeholder.classList.remove('opacity-0');
        }
      });
    });
  </script>

  <style>
    .custom-scrollbar::-webkit-scrollbar {
        width: 6px;
    }
    .custom-scrollbar::-webkit-scrollbar-track {
        background: transparent; 
    }
    .custom-scrollbar::-webkit-scrollbar-thumb {
        background: #334155; 
        border-radius: 10px;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background: #475569; 
    }
  </style>

</Layout>