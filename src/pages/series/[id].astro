---
import { getCollection, render } from 'astro:content';
import Layout from '../../layouts/Layout.astro';
import { SERIES_MAP, SEASON_MAP } from '../../utils/seriesMap';

export async function getStaticPaths() {
  const allSongs = await getCollection('songs');
  const uniqueSeries = [...new Set(allSongs.map(song => song.slug.split('/')[0]))];
  return uniqueSeries.map(seriesId => ({
    params: { id: seriesId },
    props: { seriesId }
  }));
}

const { id } = Astro.params;

// 1. LẤY THÔNG TIN SERIES
const seriesInfo = SERIES_MAP[id] || { romaji: id, vietnamese: id, year: "" };

// 2. LẤY & SORT BÀI HÁT
const seriesSongs = (await getCollection('songs'))
  .filter(song => song.slug.startsWith(`${id}/`))
  .sort((a, b) => (a.data.date?.valueOf() || 0) - (b.data.date?.valueOf() || 0));

// 3. GOM NHÓM
const groupedSongs = {};
const songLabels = {};

for (const song of seriesSongs) {
  const parts = song.slug.split('/');
  const originalFolder = parts.length > 2 ? parts[1] : '99_misc'; 

  if (!groupedSongs[originalFolder]) {
    groupedSongs[originalFolder] = [];
  }
  
  const { Content } = await render(song);
  groupedSongs[originalFolder].push({ ...song, Content });
}

// Logic Tag
Object.keys(groupedSongs).forEach(key => {
    const list = groupedSongs[key];
    const assign = (l, p) => l.forEach((s, i) => songLabels[s.slug] = l.length > 1 ? `${p}${i+1}` : p);
    assign(list.filter(s => s.data.type === 'OP'), 'OP');
    assign(list.filter(s => s.data.type === 'ED'), 'ED');
    assign(list.filter(s => s.data.type === 'INS'), 'INS');
});

const sortedGroups = Object.keys(groupedSongs).sort();
const tvSeasonsCount = sortedGroups.filter(key => key.includes('season-')).length;
const contentGroupsCount = sortedGroups.filter(key => !key.includes('misc')).length;

// LOGIC HEADING
const formatHeading = (originalFolder) => {
  const cleanFolder = originalFolder.replace(/^\d+_/, ''); 
  let mappedName = SEASON_MAP[cleanFolder];

  // Logic xử lý tên
  let result = "";

  if (cleanFolder === 'misc' || cleanFolder.includes('misc') || mappedName === 'Miscellaneous') {
    result = 'LINH TINH'; 
  } else {
    const firstSongInGroup = groupedSongs[originalFolder][0];
    
    // Ưu tiên custom season
    if (firstSongInGroup?.data.season) {
        result = `${seriesInfo.vietnamese} - ${firstSongInGroup.data.season}`;
    } 
    // TV Series duy nhất
    else if (cleanFolder.startsWith('season-') && tvSeasonsCount === 1) {
        result = seriesInfo.vietnamese; 
    }
    // Movie duy nhất
    else if (cleanFolder === 'movie' && contentGroupsCount === 1) {
        result = seriesInfo.vietnamese;
    }
    // Mặc định
    else {
        let finalSeasonName = mappedName || cleanFolder.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
        result = `${seriesInfo.vietnamese} - ${finalSeasonName}`;
    }
  }

  // Trả về IN HOA TOÀN BỘ theo yêu cầu
  return result.toUpperCase();
};

const pageTitle = `${seriesInfo.vietnamese} (${seriesInfo.year})`;
---

<Layout title={`${pageTitle} | Rainei Lyrics List`}>
  
  <div class="max-w-[1600px] mx-auto pt-8 px-4 lg:grid lg:grid-cols-10 lg:gap-10 relative">
    
    <main class="lg:col-span-7 pb-20">
      
      <div class="mb-12 border-b border-slate-800 pb-6">
        <h1 class="text-3xl md:text-5xl font-extrabold text-white leading-tight mb-2">
          {seriesInfo.vietnamese}
        </h1>
        <div class="text-xl text-slate-400 font-light flex items-center gap-2">
            <span>{seriesInfo.romaji}</span>
            {seriesInfo.year && <span class="text-slate-600">• {seriesInfo.year}</span>}
        </div>
      </div>

      <div class="space-y-20">
        {sortedGroups.map(groupKey => (
          <section id={`group-${groupKey}`} class="scroll-mt-8">
            
            <h2 class="text-2xl font-bold text-sky-400 mb-8 border-l-4 border-sky-500 pl-4 group/heading">
              <a href={`#group-${groupKey}`} class="hover:text-sky-300 transition-colors flex items-center gap-2">
                {formatHeading(groupKey)}
                <span class="opacity-0 group-hover/heading:opacity-100 text-slate-600 text-lg transition-opacity">#</span>
              </a>
            </h2>

            <div class="space-y-16">
              {groupedSongs[groupKey].map(song => {
                const tag = songLabels[song.slug];
                const songId = song.slug.split('/').pop(); 
                
                return (
                  <article id={songId} class="scroll-mt-24 group/article"> 
                    
                    <div class="mb-6">
                        <h3 class="text-2xl font-bold text-white mb-1 flex items-center gap-3">
                        {tag && <span class="px-2 py-0.5 rounded text-sm bg-sky-500/10 text-sky-400 border border-sky-500/20">{tag}</span>}
                        <span>{song.data.title}</span>
                        </h3>
                        {song.data.artist && (
                            <div class="text-lg text-slate-400 italic">
                                — {song.data.artist}
                            </div>
                        )}
                    </div>

                    <div class="pl-1 md:pl-4 border-l border-slate-800/50 group-hover/article:border-sky-500/30 transition-colors">
                      <div class="prose prose-invert prose-lg max-w-none 
                                  prose-p:leading-relaxed prose-p:mb-5 prose-p:text-slate-300
                                  prose-headings:text-sky-300 prose-a:text-sky-400">
                        <song.Content />
                      </div>
                    </div>

                  </article>
                );
              })}
            </div>

          </section>
        ))}
      </div>
    </main>

    <aside class="hidden lg:flex lg:col-span-3 flex-col gap-4 sticky top-8 self-start">
      
      <div class="flex justify-end w-full">
        <a 
            href={import.meta.env.BASE_URL}
            class="flex items-center gap-2 text-sm text-slate-400 hover:text-white transition-colors bg-slate-900/50 px-4 py-2 rounded-full border border-slate-800 hover:border-sky-500/50 hover:bg-slate-800"
            title="Quay lại trang chủ"
        >
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>
            Quay lại
        </a>
      </div>

      <div class="bg-slate-900/40 backdrop-blur border border-slate-800 rounded-xl p-5 max-h-[calc(100vh-8rem)] overflow-y-auto custom-scrollbar w-full">
        
        <h3 class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-6 pb-2 border-b border-slate-800">
          MỤC LỤC
        </h3>

        <nav class="space-y-3">
          {sortedGroups.map(groupKey => (
            <div>
              <a 
                href={`#group-${groupKey}`}
                class="block text-sm font-bold text-sky-400 mb-3 truncate hover:text-sky-300 transition-colors" 
                title={formatHeading(groupKey)}
              >
                 {formatHeading(groupKey)}
              </a>
              
              <ul class="space-y-4 border-l border-slate-800 ml-1">
                {groupedSongs[groupKey].map(song => {
                   const tag = songLabels[song.slug];
                   const songId = song.slug.split('/').pop();
                   
                   return (
                    <li class="pl-4 relative group">
                      <a href={`#${songId}`} class="block transition-colors">
                        <span class="absolute -left-[1px] top-0 bottom-0 w-[2px] bg-transparent group-hover:bg-sky-500 transition-colors"></span>
                        
                        <div class="flex items-baseline gap-3 mb-1">
                            <div class="shrink-0 w-8 text-right text-xs font-bold text-sky-500 font-mono">
                                {tag}
                            </div>
                            <div class="flex-1 text-sm text-slate-300 group-hover:text-white font-medium leading-tight">
                                {song.data.title}
                            </div>
                        </div>

                        <div class="pl-11 text-xs text-slate-500 group-hover:text-slate-400 italic">
                            {song.data.artist}
                        </div>
                      </a>
                    </li>
                   );
                })}
              </ul>
            </div>
          ))}
        </nav>

      </div>
    </aside>

  </div>

  <button 
    id="mobile-toc-btn"
    class="fixed bottom-6 right-6 lg:hidden z-50 bg-sky-500 hover:bg-sky-600 text-white font-bold py-3 px-6 rounded-full shadow-lg shadow-sky-500/30 flex items-center gap-2 transition-transform active:scale-95"
  >
    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>
    Danh sách
  </button>
  
  <a href={import.meta.env.BASE_URL} class="fixed bottom-24 right-6 lg:hidden z-40 bg-slate-800 text-white p-3 rounded-full shadow-lg border border-slate-700">
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>
  </a>

  <div id="mobile-toc-overlay" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-[60] hidden opacity-0 transition-opacity duration-300">
    <div id="mobile-toc-content" class="absolute right-0 top-0 bottom-0 w-[85%] max-w-sm bg-slate-900 border-l border-slate-800 p-6 overflow-y-auto translate-x-full transition-transform duration-300">
        
        <div class="flex justify-between items-center mb-6 border-b border-slate-800 pb-4">
            <h3 class="text-lg font-bold text-white">Danh sách bài hát</h3>
            <button id="close-toc-btn" class="p-2 text-slate-400 hover:text-white">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 18 12"/></svg>
            </button>
        </div>

        <nav class="space-y-6">
            {sortedGroups.map(groupKey => (
              <div>
                <a 
                  href={`#group-${groupKey}`}
                  class="mobile-toc-link block text-sm font-bold text-sky-400 mb-3"
                >
                   {formatHeading(groupKey)}
                </a>
                <ul class="space-y-4">
                  {groupedSongs[groupKey].map(song => {
                     const songId = song.slug.split('/').pop();
                     return (
                      <li>
                        <a href={`#${songId}`} class="mobile-toc-link block">
                          <div class="text-sm text-slate-200 font-medium mb-0.5">
                            {song.data.title}
                          </div>
                          <div class="text-xs text-slate-500 italic">
                             {song.data.artist}
                          </div>
                        </a>
                      </li>
                     );
                  })}
                </ul>
              </div>
            ))}
        </nav>
    </div>
  </div>

  <script>
    const btn = document.getElementById('mobile-toc-btn');
    const closeBtn = document.getElementById('close-toc-btn');
    const overlay = document.getElementById('mobile-toc-overlay');
    const content = document.getElementById('mobile-toc-content');
    const links = document.querySelectorAll('.mobile-toc-link');

    function toggleMenu() {
        const isHidden = overlay.classList.contains('hidden');
        if (isHidden) {
            overlay.classList.remove('hidden');
            setTimeout(() => {
                overlay.classList.remove('opacity-0');
                content.classList.remove('translate-x-full');
            }, 10);
        } else {
            overlay.classList.add('opacity-0');
            content.classList.add('translate-x-full');
            setTimeout(() => {
                overlay.classList.add('hidden');
            }, 300);
        }
    }

    btn.addEventListener('click', toggleMenu);
    closeBtn.addEventListener('click', toggleMenu);
    overlay.addEventListener('click', (e) => {
        if (e.target === overlay) toggleMenu();
    });
    
    links.forEach(link => {
        link.addEventListener('click', toggleMenu);
    });
  </script>

  <style>
    .custom-scrollbar::-webkit-scrollbar {
        width: 4px;
    }
    .custom-scrollbar::-webkit-scrollbar-track {
        background: rgba(30, 41, 59, 0.5); 
    }
    .custom-scrollbar::-webkit-scrollbar-thumb {
        background: #38bdf8; 
        border-radius: 4px;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background: #0ea5e9; 
    }
  </style>

</Layout>